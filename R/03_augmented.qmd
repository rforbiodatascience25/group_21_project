---
title: "Data augmentation"
format:
  html:
    embed-resources: true
editor: visual
---

## Loading libraries
```{r}
#| warning: false
#| message: false

library("tidyverse")
source("99_proj_func.R")
```

## Loading data
```{r}
#| warning: false
#| message: false
metadata_clean <- read_tsv("../data/02_dat_metadata_clean.tsv")
raw_counts <- read_tsv("../data/01_dat_raw_counts.tsv")
```

## Augmenting
```{r}
# Creating age groups
metadata_clean <- metadata_clean |> 
  mutate(Age_groups = cut(Age,
                          breaks = c(18,40,60,82),
                          labels = c("Young", "Middle", "Older"),
                          right = FALSE))

# Normalizing counts
cpm_counts <- CPM_normalization(raw_counts)
quant_counts <- quantile_normalization(raw_counts)

# Calculating GEP scores
augmented_metadata <- GEP_score_calculation(quant_counts, metadata_clean)

# Pivoting normalized counts to long format 
cpm_long <- cpm_counts |> 
  pivot_longer(cols = -GeneFeature,
               names_to = "Sample_names",
               values_to = "CPM")
quant_long <- quant_counts |> 
  pivot_longer(cols = -GeneFeature,
               names_to = "Sample_names",
               values_to = "Quantile")

# Joining data
joined_data <- quant_long |> 
  left_join(cpm_long, 
            by = c("Sample_names", "GeneFeature")) |> 
  left_join(augmented_metadata, 
            by = "Sample_names")

# Binarizing TLS_status and log-transforming CPM counts
joined_data <- joined_data |>
  mutate(TLS_status_bin = if_else(TLS_status == "control", 0, 1)) |>
  mutate(CPM_log2 = log(CPM+1, base=2))

augmented_metadata <- augmented_metadata |>
  mutate(TLS_status_bin = if_else(TLS_status == "control", 0, 1))

# Saving final table
write_tsv(joined_data, "../data/03_augmented_table.tsv")
write_tsv(augmented_metadata, "../data/03_augmented_metadata.tsv")
```
